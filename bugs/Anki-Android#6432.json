{
    "apk_name": "Anki-Android_v2.11.0.apk",
    "url": "https://github.com/ankidroid/Anki-Android/issues/6432",
    "repo": "Anki-Android",
    "title": "Crash in Card Browser, the multi-select mode: Edit => change the card type",
    "body": "###### Reproduction Steps\r\n\r\n1. Create any type and clone it (to keep things simple, I've just used basic, calling the types \"Basic 1\" & \"Basic 2\").\r\n2. Add two cards to the first type.\r\n3. Browser â†’ select the two new cards â†’ Edit â†’ try to change the type (in my case, \"Basic 1\" â†’ \"Basic 2\"). \r\n\r\n\r\n###### Expected Result\r\nIf you could allow there some sort of batch type reassignment via the default field mapping, that would be perfect!\r\n\r\n\r\n###### Actual Result\r\n\r\nIt crashes, only the first card is affected by the change.\r\n\r\n\r\n###### Debug info\r\nRefer to the [support page](https://ankidroid.org/docs/help.html) if you are unsure where to get the \"debug info\".\r\n\r\n###### Research\r\n*Enter an [x] character to confirm the points below:*\r\n\r\n--- I've reported it via the play.google.com, your representative there suggested that I report it here.\r\n\r\n\r\n- [ ] I have read the [support page](https://ankidroid.org/docs/help.html) and am reporting a bug or enhancement request specific to AnkiDroid\r\n- [ ] I have checked the [manual](https://ankidroid.org/docs/manual.html) and the [FAQ](https://github.com/ankidroid/Anki-Android/wiki/FAQ) and could not find a solution to my issue\r\n- [ ] I have searched for similar existing issues here and on the user forum\r\n- [ ] (Optional) I have confirmed the issue is not resolved in the latest alpha release ([instructions](https://docs.ankidroid.org/manual.html#betaTesting))\r\n\r\n",
    "comments": [
        "Hello! ðŸ‘‹ Thanks for logging this issue. Please remember we are all volunteers here, so some patience may be required before we can get to the issue. Also remember that the fastest way to get resolution on an issue is to propose a change directly, https://github.com/ankidroid/Anki-Android/wiki/Contributing",
        "Guys, your program is great! The issue is, obviously, not pressing at all: my main goal has been to contribute a tiny bit via reporting this. Thank you!",
        "Hey @dymky - thanks for logging this! I think this is an unexpected side-effect of #6243 - the idea with that one was that even in multi-select mode we could enable edit note but just have it affect the first card. That use case should not crash at minimum, but if it gives people the impression they can change the card type and it will affect multiple notes, that's not correct\r\n\r\nThen at the same time, changing multiple card types at once is a popular feature (and something I'd love myself)\r\n\r\nI think #6243 might need a revert now that I think about it - there may be other note-related things that would confuse people if they thought it would apply to all the selected notes but it really just affects one, and the feature of changing note type for multiple notes at once is still on the wish list",
        "In upstream, for the change note type, it instead checks whether all selected card have same note type. It would be a really easy change here. At least as far as we only apply simple rules such as \"field 1 goes to field 1\"...",
        "@dymky when you say Â«it crashedÂ», do you mean the program actually stop, or only that it did not do what is expected ? \r\nDid you accepted to send report ? In which case we may have the crash report. But we would need informations from https://docs.ankidroid.org/help.html to find it (at least if I understand things correctly. I'm new here)",
        "> I think #6243 might need a revert now that I think about it - there may be other note-related things that would confuse people if they thought it would apply to all the selected notes but it really just affects one, and the feature of changing note type for multiple notes at once is still on the wish list\r\n\r\nIt was #6243. Apologies.\r\n\r\nTo note: #6243 was intended to only show the \"edit note\" dialog if all selected cards are on the same note. It should not have appeared when multiple notes were selected.\r\n\r\nThis is an issue between changing the note type while we are in multiselect mode.\r\n\r\n<details><summary>Stack Trace</summary>\r\n\r\n\r\n```\r\n2020-06-11 14:11:59.122 24055-24149/com.ichi2.anki E/com.ichi2.anki: [qarth_debug:]  get PatchStore::createDisableExceptionQarthFile method fail.\r\n2020-06-11 14:11:59.140 24055-24149/com.ichi2.anki E/AndroidRuntime: FATAL EXCEPTION: AsyncTask #4\r\n    Process: com.ichi2.anki, PID: 24055\r\n    java.lang.RuntimeException: An error occurred while executing doInBackground()\r\n        at android.os.AsyncTask$3.done(AsyncTask.java:355)\r\n        at java.util.concurrent.FutureTask.finishCompletion(FutureTask.java:383)\r\n        at java.util.concurrent.FutureTask.setException(FutureTask.java:252)\r\n        at java.util.concurrent.FutureTask.run(FutureTask.java:271)\r\n        at android.os.AsyncTask$SerialExecutor$1.run(AsyncTask.java:246)\r\n        at java.util.concurrent.ThreadPoolExecutor.processTask(ThreadPoolExecutor.java:1187)\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1152)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:641)\r\n        at java.lang.Thread.run(Thread.java:784)\r\n     Caused by: java.lang.IndexOutOfBoundsException: Index: 1, Size: 0\r\n        at java.util.ArrayList.get(ArrayList.java:437)\r\n        at com.ichi2.async.CollectionTask.doInBackgroundCheckCardSelection(CollectionTask.java:1573)\r\n        at com.ichi2.async.CollectionTask.doInBackground(CollectionTask.java:355)\r\n        at com.ichi2.async.CollectionTask.doInBackground(CollectionTask.java:73)\r\n        at android.os.AsyncTask$2.call(AsyncTask.java:334)\r\n        at java.util.concurrent.FutureTask.run(FutureTask.java:266)\r\n        at android.os.AsyncTask$SerialExecutor$1.run(AsyncTask.java:246)Â \r\n        at java.util.concurrent.ThreadPoolExecutor.processTask(ThreadPoolExecutor.java:1187)Â \r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1152)Â \r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:641)Â \r\n        at java.lang.Thread.run(Thread.java:784)Â \r\n```\r\n</details>\r\n\r\nData flow:\r\n\r\n* `onActivityResult` -> save card edit -> search cards\r\n\r\n----\r\n\r\n* `onCreateOptionsMenu` -> `mInMultiSelectMode = true`\r\n* `updateMultiselectMenu`\r\n* `TASK_TYPE_CHECK_CARD_SELECTION` -> crash. This task is passed in both the card positions and the card lists. These are out of sync due to the searchCards call.\r\n",
        "Hi,\r\n\r\nThank you!\r\n\r\nBy crash I mean program crashing. I have not submitted a crash report, but before starting this thread I had tried it on a freshly created \"toy example\" (as described above) and it crashed right away: so it must be really straightforward to reproduce (and most likely related to the recent change, as suggested above).\r\n\r\nIndeed, changing the type for multiple cards at once would take your great program to yet another level of usability (for me, at least): I keep adjusting my own \"generic\" card type to my needs, and from time to time it happens that I \"split\" a previous \"general-purpose\" field into several more specific ones: in such cases it would be great to be able to convert many cards at once to the new type mechanically.\r\n\r\nMaybe in the meanwhile you could add some most basic option for that? Say, if I delete a non-empty card type, the program might offer to convert all its cards to some other type by performing the most trivial field-mapping action? With this simple operation what I usually need would be achievable (even if via some intermediate steps).\r\n"
    ]
}